<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falling Bricks Breakout v2</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        // Firebase ì„¤ì • - ramgaku-playgrnd-rankdb í”„ë¡œì íŠ¸ (í…ŒìŠ¤íŠ¸ìš©)
        const firebaseConfig = {
            apiKey: "demo-api-key-for-github-pages", 
            authDomain: "ramgaku-playgrnd-rankdb.firebaseapp.com", 
            databaseURL: "https://ramgaku-playgrnd-rankdb-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "ramgaku-playgrnd-rankdb",
            storageBucket: "ramgaku-playgrnd-rankdb.appspot.com",
            messagingSenderId: "123456789", 
            appId: "demo-app-id-for-public-access"
        };
        
        let firebaseApp, database;
        let isFirebaseEnabled = false;
        
        try {
            firebaseApp = initializeApp(firebaseConfig);
            database = getDatabase(firebaseApp);
            isFirebaseEnabled = true;
            console.log('ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ!');
            console.log('ğŸ“ Database URL:', firebaseConfig.databaseURL);
            
            // ì—°ê²° í…ŒìŠ¤íŠ¸
            const testRef = ref(database, '.info/connected');
            onValue(testRef, (snapshot) => {
                const connected = snapshot.val();
                console.log(connected ? 'âœ… Firebase ì‹¤ì‹œê°„ ì—°ê²°ë¨' : 'âŒ Firebase ì—°ê²° ëŠì–´ì§');
            });
            
        } catch (error) {
            console.log('âš ï¸ Firebase ì—°ê²° ì‹¤íŒ¨ (ë¡œì»¬/ë°ëª¨ ëª¨ë“œ):', error);
            console.log('ğŸ“‹ ì„¤ì •ê°’:', firebaseConfig);
            isFirebaseEnabled = false;
        }
        
        // ì „ì—­ Firebase í•¨ìˆ˜ë“¤
        window.saveScore = async function(playerName, score, level) {
            if (!isFirebaseEnabled) {
                console.log('Firebase ë¯¸ì—°ê²° ìƒíƒœ - ë¡œì»¬ ì ìˆ˜ ì €ì¥');
                saveLocalScore(playerName, score, level);
                return;
            }
            
            try {
                const scoresRef = ref(database, 'falling-breakout-scores');
                await push(scoresRef, {
                    name: playerName.substring(0, 10), // ì´ë¦„ ê¸¸ì´ ì œí•œ
                    score: score,
                    level: level,
                    timestamp: Date.now(),
                    date: new Date().toISOString().split('T')[0]
                });
                console.log('ğŸ’¾ ì ìˆ˜ ì €ì¥ ì™„ë£Œ!');
                loadRankings();
            } catch (error) {
                console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
                saveLocalScore(playerName, score, level);
            }
        };
        
        window.loadRankings = function() {
            if (!isFirebaseEnabled) {
                console.log('Firebase ë¯¸ì—°ê²° - ë¡œì»¬ ë­í‚¹ ë¡œë“œ');
                loadLocalRankings();
                return;
            }
            
            try {
                const scoresRef = ref(database, 'falling-breakout-scores');
                const topScoresQuery = query(scoresRef, orderByChild('score'), limitToLast(10));
                
                onValue(topScoresQuery, (snapshot) => {
                    const scores = [];
                    snapshot.forEach((childSnapshot) => {
                        scores.push(childSnapshot.val());
                    });
                    
                    // ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
                    scores.sort((a, b) => b.score - a.score);
                    displayRankings(scores);
                });
            } catch (error) {
                console.error('ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                loadLocalRankings();
            }
        };
        
        // ë¡œì»¬ ì €ì¥ì†Œ ë°±ì—… ì‹œìŠ¤í…œ
        function saveLocalScore(name, score, level) {
            let localScores = JSON.parse(localStorage.getItem('falling-breakout-local-scores') || '[]');
            localScores.push({
                name: name,
                score: score,
                level: level,
                timestamp: Date.now(),
                date: new Date().toISOString().split('T')[0]
            });
            
            // ìƒìœ„ 20ê°œë§Œ ë³´ê´€
            localScores.sort((a, b) => b.score - a.score);
            localScores = localScores.slice(0, 20);
            
            localStorage.setItem('falling-breakout-local-scores', JSON.stringify(localScores));
            loadLocalRankings();
        }
        
        function loadLocalRankings() {
            const localScores = JSON.parse(localStorage.getItem('falling-breakout-local-scores') || '[]');
            displayRankings(localScores.slice(0, 10));
        }
        
        function displayRankings(scores) {
            const rankingList = document.getElementById('rankingList');
            if (!rankingList) return;
            
            rankingList.innerHTML = '';
            
            if (scores.length === 0) {
                rankingList.innerHTML = '<div class="no-scores">ì•„ì§ ë“±ë¡ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            scores.forEach((score, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'ranking-item';
                rankingItem.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <span class="name">${score.name}</span>
                    <span class="score">${score.score.toLocaleString()}</span>
                    <span class="level">Lv.${score.level}</span>
                `;
                rankingList.appendChild(rankingItem);
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ ë¡œë“œ
        window.addEventListener('load', () => {
            setTimeout(loadRankings, 500); // ê²Œì„ ì´ˆê¸°í™” í›„ ë¡œë“œ
        });
        
        window.isFirebaseEnabled = () => isFirebaseEnabled;
    </script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000 100%);
            font-family: 'Consolas', 'Monaco', monospace;
        }
        #gameContainer {
            text-align: center;
            max-width: 100%;
        }
        #gameCanvas {
            border: 2px solid #00ffff;
            background: #000;
            box-shadow: 0 0 20px #00ffff40;
            max-width: 100%;
            height: auto;
        }
        #gameInfo {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
        }
        #score, #level, #bricksCount {
            color: #00ffff;
            font-size: clamp(14px, 2.5vw, 20px);
            text-shadow: 0 0 10px #00ffff;
        }
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        #autoToggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #00ffff;
            font-size: clamp(12px, 2.5vw, 16px);
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #333;
            border-radius: 25px;
            border: 1px solid #00ffff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: #00ffff40;
        }
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 19px;
            height: 19px;
            background: #00ffff;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 0 10px #00ffff;
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(23px);
        }
        #gameOver {
            color: #ff0080;
            font-size: clamp(20px, 5vw, 32px);
            margin-top: 20px;
            display: none;
            text-shadow: 0 0 15px #ff0080;
        }
        
        /* ë­í‚¹ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ */
        #rankingContainer {
            display: none;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 0 20px #00ffff40;
        }
        
        #rankingContainer h3 {
            color: #00ffff;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .score-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .score-input input {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00ffff;
            border-radius: 5px;
            padding: 8px 12px;
            color: #00ffff;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: center;
            max-width: 200px;
            outline: none;
        }
        
        .score-input input:focus {
            box-shadow: 0 0 10px #00ffff40;
        }
        
        .score-input input::placeholder {
            color: #00ffff60;
        }
        
        .score-info {
            color: #ff0080;
            font-size: 18px;
            text-shadow: 0 0 10px #ff0080;
            margin-bottom: 10px;
        }
        
        #rankingList {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: grid;
            grid-template-columns: 40px 1fr auto auto;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #00ffff20;
            align-items: center;
        }
        
        .ranking-item:nth-child(1) .rank { color: #ffd700; }
        .ranking-item:nth-child(2) .rank { color: #c0c0c0; }
        .ranking-item:nth-child(3) .rank { color: #cd7f32; }
        
        .ranking-item .rank {
            color: #00ffff;
            font-weight: bold;
            text-align: center;
        }
        
        .ranking-item .name {
            color: #40ff40;
            font-weight: bold;
        }
        
        .ranking-item .score {
            color: #ff8000;
            font-weight: bold;
        }
        
        .ranking-item .level {
            color: #8080ff;
            font-size: 12px;
        }
        
        .no-scores {
            color: #666;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
        
        .ranking-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(45deg, #ff0080, #8000ff);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: clamp(12px, 2.5vw, 16px);
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: all 0.3s;
        }
        .btn:hover {
            box-shadow: 0 0 15px #ff008080;
            transform: translateY(-2px);
        }
        #mobileControls {
            display: none;
            gap: 20px;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            #mobileControls {
                display: flex;
                justify-content: center;
            }
        }
        
        /* ë ˆë²¨ì—… UI íš¨ê³¼ */
        .level-up-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #80ff00;
            text-shadow: 0 0 30px #80ff00;
            z-index: 1000;
            animation: levelUpAnimation 2s ease-out;
            pointer-events: none;
        }
        
        @keyframes levelUpAnimation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1) translateY(-100px);
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="gameInfo">
            <div>
                <span id="score">ì ìˆ˜: 0</span>
                <span style="margin-left: 20px;" id="level">ë ˆë²¨: 1</span>
                <span style="margin-left: 20px;" id="bricksCount">ë²½ëŒ: 0</span>
            </div>
            
            <div id="autoToggle">
                <span>ìë™ëª¨ë“œ</span>
                <div class="toggle-switch active" onclick="toggleAutoMode()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>

        <div id="controls">
            <button class="btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
        
        <div id="mobileControls">
            <button class="btn" style="font-size: 18px; padding: 15px 30px;" onmousedown="startMobileMove('left')" onmouseup="stopMobileMove()" ontouchstart="startMobileMove('left')" ontouchend="stopMobileMove()">â†</button>
            <button class="btn" style="font-size: 18px; padding: 15px 30px;" onmousedown="startMobileMove('right')" onmouseup="stopMobileMove()" ontouchstart="startMobileMove('right')" ontouchend="stopMobileMove()">â†’</button>
        </div>
        
        <div id="gameOver">ê²Œì„ ì˜¤ë²„!</div>
        
        <!-- ë­í‚¹ ì‹œìŠ¤í…œ -->
        <div id="rankingContainer">
            <h3>ğŸ† ìµœê³  ê¸°ë¡</h3>
            
            <div id="scoreSubmitSection" style="display: none;">
                <div class="score-info">
                    ìƒˆë¡œìš´ ê¸°ë¡! <span id="finalScore"></span>ì  ë‹¬ì„±!
                </div>
                <div class="score-input">
                    <input type="text" id="playerNameInput" placeholder="ì´ë¦„ ì…ë ¥ (ìµœëŒ€ 10ì)" maxlength="10">
                    <div class="ranking-buttons">
                        <button class="btn" onclick="submitScore()">ì ìˆ˜ ë“±ë¡</button>
                        <button class="btn" onclick="skipScore()">ê±´ë„ˆë›°ê¸°</button>
                    </div>
                </div>
            </div>
            
            <div id="rankingList">
                <div class="no-scores">ë­í‚¹ì„ ë¡œë”©ì¤‘...</div>
            </div>
            
            <div class="ranking-buttons">
                <button class="btn" onclick="showRanking()">ë­í‚¹ ë³´ê¸°</button>
                <button class="btn" onclick="hideRanking()">ë‹«ê¸°</button>
                <button class="btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const bricksCountElement = document.getElementById('bricksCount');
        const gameOverElement = document.getElementById('gameOver');

        // ê²Œì„ ìƒíƒœ
        let gameState = 'playing';
        let score = 0;
        let level = 1;
        let autoMode = true;
        let autoModeInterval = null;

        // ê³µ ì‹œìŠ¤í…œ (ë‹¤ì¤‘ ê³µ ì§€ì›)
        let balls = [];

        // íŒ¨ë“¤
        const paddle = {
            x: canvas.width / 2 - 50,
            y: canvas.height - 20,
            width: 100,
            height: 10,
            speed: 8
        };

        // ì•„ì´í…œ ì‹œìŠ¤í…œ
        let items = [];
        const itemTypes = {
            BALL_ADD: { color: '#ff8000', symbol: '+', description: 'ê³µ ì¶”ê°€' },
            BALL_SPLIT: { color: '#8000ff', symbol: 'Ã—', description: 'ê³µ ë¶„ì—´' }
        };

        // ë²½ëŒ ì‹œìŠ¤í…œ ê°œì„ 
        const brickGrid = {
            rows: 20,
            cols: 12,
            cellWidth: 60,
            cellHeight: 25,
            offsetX: 40,
            offsetY: 30
        };

        let bricks = [];
        let dropTimer = 0;
        let dropSpeed = 180; // í”„ë ˆì„
        
        // HPë³„ ìƒ‰ìƒ ì‹œìŠ¤í…œ
        const hpColors = [
            '#40ff40', // HP 1 - ì—°í•œ ì´ˆë¡
            '#80ff00', // HP 2 - ì—°ë‘
            '#ffff00', // HP 3 - ë…¸ë‘
            '#ff8000', // HP 4 - ì£¼í™©
            '#ff4000', // HP 5 - ë¹¨ê°•
            '#ff0080', // HP 6 - í•‘í¬
            '#8000ff', // HP 7 - ë³´ë¼
            '#0080ff'  // HP 8 - íŒŒë‘
        ];

        // ê³µ ì´ˆê¸°í™”
        function initBalls() {
            balls = [{
                x: canvas.width / 2,
                y: canvas.height - 80,
                dx: 4 + Math.random() * 2 - 1,
                dy: -4 - Math.random() * 2,
                radius: 8,
                trail: []
            }];
        }

        // ë²½ëŒ ì´ˆê¸°í™” (ìœ„ì—ì„œë¶€í„° ë–¨ì–´ì§€ëŠ” ë°©ì‹)
        function initBricks() {
            bricks = [];
            for (let r = 0; r < brickGrid.rows; r++) {
                bricks[r] = [];
                for (let c = 0; c < brickGrid.cols; c++) {
                    bricks[r][c] = null;
                }
            }
            
            // ì´ˆê¸° ë²½ëŒ ë°°ì¹˜ (ìœ„ì—ì„œë¶€í„° ëª‡ ì¤„ë§Œ)
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < brickGrid.cols; c++) {
                    if (Math.random() < 0.4) {
                        createBrick(r, c);
                    }
                }
            }
        }

        // ë²½ëŒ ìƒì„±
        function createBrick(row, col, forceHp = null) {
            if (row >= 0 && row < brickGrid.rows && col >= 0 && col < brickGrid.cols) {
                const maxHp = Math.min(level + 2, 8);
                const hp = forceHp || Math.floor(Math.random() * maxHp) + 1;
                const isSpecial = Math.random() < 0.15; // 15% í™•ë¥ ë¡œ ì•„ì´í…œ ë²½ëŒ
                
                bricks[row][col] = {
                    x: brickGrid.offsetX + col * brickGrid.cellWidth,
                    y: brickGrid.offsetY + row * brickGrid.cellHeight,
                    hp: hp,
                    maxHp: hp,
                    color: hpColors[(hp - 1) % hpColors.length],
                    glowIntensity: 0.3 + (hp / maxHp) * 0.7,
                    isSpecial: isSpecial,
                    specialItem: isSpecial ? (Math.random() < 0.5 ? 'BALL_ADD' : 'BALL_SPLIT') : null,
                    fadeEffect: 0
                };
            }
        }

        // ë²½ëŒ ë–¨ì–´ëœ¨ë¦¬ê¸° (ìœ„ì—ì„œë¶€í„° í•œ ì¤„ì”© ë°€ë ¤ë‚´ë¦¬ê¸°)
        function dropNewBrickLine() {
            // ëª¨ë“  ë²½ëŒì„ í•œ ì¹¸ ì•„ë˜ë¡œ ë°€ì–´ë‚´ê¸°
            for (let r = brickGrid.rows - 1; r > 0; r--) {
                for (let c = 0; c < brickGrid.cols; c++) {
                    bricks[r][c] = bricks[r - 1][c];
                    if (bricks[r][c]) {
                        bricks[r][c].y = brickGrid.offsetY + r * brickGrid.cellHeight;
                    }
                }
            }
            
            // ì²« ë²ˆì§¸ í–‰ì— ìƒˆë¡œìš´ ë²½ëŒ ë¼ì¸ ìƒì„±
            for (let c = 0; c < brickGrid.cols; c++) {
                bricks[0][c] = null;
                // ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ë²½ëŒ ìƒì„± í™•ë¥  ì¦ê°€
                if (Math.random() < 0.3 + (level * 0.05)) {
                    createBrick(0, c);
                }
            }
            
            checkGameOver();
        }

        // ì•„ì´í…œ ìƒì„±
        function createItem(x, y, type) {
            items.push({
                x: x,
                y: y,
                type: type,
                dy: 2,
                radius: 12,
                life: 300,
                glow: 0
            });
        }

        // ì•„ì´í…œ ì—…ë°ì´íŠ¸
        function updateItems() {
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                item.y += item.dy;
                item.life--;
                item.glow = (Math.sin(Date.now() * 0.01) + 1) * 0.5;
                
                // íŒ¨ë“¤ê³¼ ì¶©ëŒ ì²´í¬
                if (item.y + item.radius > paddle.y &&
                    item.x > paddle.x &&
                    item.x < paddle.x + paddle.width) {
                    
                    activateItem(item.type);
                    items.splice(i, 1);
                    continue;
                }
                
                // í™”ë©´ ë°–ì´ë‚˜ ì‹œê°„ ì´ˆê³¼
                if (item.y > canvas.height || item.life <= 0) {
                    items.splice(i, 1);
                }
            }
        }

        // ì•„ì´í…œ íš¨ê³¼ í™œì„±í™”
        function activateItem(type) {
            switch (type) {
                case 'BALL_ADD':
                    // ìƒˆë¡œìš´ ê³µ ì¶”ê°€
                    balls.push({
                        x: paddle.x + paddle.width / 2,
                        y: paddle.y - 20,
                        dx: (Math.random() - 0.5) * 8,
                        dy: -4 - Math.random() * 2,
                        radius: 8,
                        trail: []
                    });
                    score += 100;
                    break;
                    
                case 'BALL_SPLIT':
                    // ëª¨ë“  ê³µì„ 2ê°œë¡œ ë¶„ì—´
                    const newBalls = [];
                    balls.forEach(ball => {
                        newBalls.push({
                            x: ball.x,
                            y: ball.y,
                            dx: ball.dx + (Math.random() - 0.5) * 2,
                            dy: ball.dy,
                            radius: 8,
                            trail: []
                        });
                    });
                    balls.push(...newBalls);
                    score += 200;
                    break;
            }
            
            scoreElement.textContent = `ì ìˆ˜: ${score}`;
        }

        // ì•„ì´í…œ ë Œë”ë§
        function drawItems() {
            items.forEach(item => {
                const itemConfig = itemTypes[item.type];
                
                // ê¸€ë¡œìš° íš¨ê³¼
                ctx.shadowColor = itemConfig.color;
                ctx.shadowBlur = 20 * (0.5 + item.glow * 0.5);
                
                // ì•„ì´í…œ ë°°ê²½
                ctx.fillStyle = itemConfig.color + '80';
                ctx.beginPath();
                ctx.arc(item.x, item.y, item.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // ì‹¬ë³¼
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#ffffff';
                ctx.font = '16px Consolas';
                ctx.textAlign = 'center';
                ctx.fillText(itemConfig.symbol, item.x, item.y + 6);
            });
        }

        // ë²½ëŒ ë Œë”ë§
        function drawBricks() {
            let totalBricks = 0;
            
            for (let r = 0; r < brickGrid.rows; r++) {
                for (let c = 0; c < brickGrid.cols; c++) {
                    const brick = bricks[r][c];
                    if (brick) {
                        totalBricks++;
                        
                        // íŠ¹ìˆ˜ ë²½ëŒ íš¨ê³¼
                        if (brick.isSpecial) {
                            const pulse = Math.sin(Date.now() * 0.01) * 0.3 + 0.7;
                            ctx.shadowColor = '#ffffff';
                            ctx.shadowBlur = 15 * pulse;
                        } else {
                            ctx.shadowColor = brick.color;
                            ctx.shadowBlur = 15 * brick.glowIntensity;
                        }
                        
                        // ë²½ëŒ ê·¸ë¦¬ê¸°
                        ctx.fillStyle = brick.color;
                        ctx.fillRect(brick.x + 1, brick.y + 1, brickGrid.cellWidth - 4, brickGrid.cellHeight - 4);
                        
                        // íŠ¹ìˆ˜ ë²½ëŒ í…Œë‘ë¦¬
                        if (brick.isSpecial) {
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(brick.x + 1, brick.y + 1, brickGrid.cellWidth - 4, brickGrid.cellHeight - 4);
                        }
                        
                        // HP í‘œì‹œ
                        ctx.shadowBlur = 0;
                        ctx.fillStyle = '#000000';
                        ctx.font = '14px Consolas';
                        ctx.textAlign = 'center';
                        ctx.fillText(
                            brick.hp,
                            brick.x + brickGrid.cellWidth / 2,
                            brick.y + brickGrid.cellHeight / 2 + 5
                        );
                        
                        // íŠ¹ìˆ˜ ì•„ì´í…œ ì‹¬ë³¼
                        if (brick.isSpecial) {
                            ctx.fillStyle = '#ffffff';
                            ctx.font = '10px Consolas';
                            ctx.fillText(
                                itemTypes[brick.specialItem].symbol,
                                brick.x + brickGrid.cellWidth - 8,
                                brick.y + 12
                            );
                        }
                    }
                }
            }
            
            bricksCountElement.textContent = `ë²½ëŒ: ${totalBricks}`;
        }

        // ê³µ ë Œë”ë§
        function drawBalls() {
            balls.forEach(ball => {
                // íŠ¸ë ˆì¼ íš¨ê³¼
                for (let i = 0; i < ball.trail.length; i++) {
                    const trail = ball.trail[i];
                    const alpha = (i + 1) / ball.trail.length * 0.5;
                    
                    ctx.shadowColor = '#00ffff';
                    ctx.shadowBlur = 10;
                    ctx.fillStyle = `rgba(0, 255, 255, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(trail.x, trail.y, ball.radius * 0.7, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // ê³µ ë³¸ì²´
                ctx.shadowColor = '#00ffff';
                ctx.shadowBlur = 20;
                ctx.fillStyle = '#00ffff';
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // íŒ¨ë“¤ ë Œë”ë§
        function drawPaddle() {
            const gradient = ctx.createLinearGradient(paddle.x, paddle.y, paddle.x, paddle.y + paddle.height);
            gradient.addColorStop(0, '#ff0080');
            gradient.addColorStop(1, '#8000ff');
            
            ctx.shadowColor = '#ff0080';
            ctx.shadowBlur = 15;
            ctx.fillStyle = gradient;
            ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
        }

        // ì¶©ëŒ ê°ì§€
        function collisionDetection() {
            balls.forEach(ball => {
                for (let r = 0; r < brickGrid.rows; r++) {
                    for (let c = 0; c < brickGrid.cols; c++) {
                        const brick = bricks[r][c];
                        if (brick) {
                            if (ball.x > brick.x && 
                                ball.x < brick.x + brickGrid.cellWidth && 
                                ball.y > brick.y && 
                                ball.y < brick.y + brickGrid.cellHeight) {
                                
                                ball.dy = -ball.dy;
                                
                                // ë²½ëŒ HP ê°ì†Œ
                                brick.hp--;
                                brick.fadeEffect = 1.0;
                                
                                score += 10 * level;
                                scoreElement.textContent = `ì ìˆ˜: ${score}`;
                                
                                // ë²½ëŒ íŒŒê´´
                                if (brick.hp <= 0) {
                                    // íŠ¹ìˆ˜ ì•„ì´í…œ ë“œë¡­
                                    if (brick.isSpecial) {
                                        createItem(
                                            brick.x + brickGrid.cellWidth / 2,
                                            brick.y + brickGrid.cellHeight / 2,
                                            brick.specialItem
                                        );
                                    }
                                    
                                    bricks[r][c] = null;
                                    score += 50 * level;
                                    scoreElement.textContent = `ì ìˆ˜: ${score}`;
                                }
                                
                                checkLevelUp();
                                return;
                            }
                        }
                    }
                }
            });
        }

        // ë ˆë²¨ì—… ì²´í¬
        function checkLevelUp() {
            const newLevel = Math.floor(score / 2000) + 1;
            if (newLevel > level) {
                level = newLevel;
                levelElement.textContent = `ë ˆë²¨: ${level}`;
                dropSpeed = Math.max(60, 180 - level * 15);
                
                // ë ˆë²¨ì—… UI íš¨ê³¼
                createLevelUpEffect();
            }
        }

        // ë ˆë²¨ì—… UI íš¨ê³¼
        function createLevelUpEffect() {
            const effect = document.createElement('div');
            effect.className = 'level-up-effect';
            effect.textContent = `LEVEL ${level}!`;
            document.body.appendChild(effect);
            
            setTimeout(() => {
                document.body.removeChild(effect);
            }, 2000);
        }

        // ê³µ ì—…ë°ì´íŠ¸
        function updateBalls() {
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                
                // íŠ¸ë ˆì¼ ì—…ë°ì´íŠ¸
                ball.trail.push({x: ball.x, y: ball.y});
                if (ball.trail.length > 5) {
                    ball.trail.shift();
                }
                
                ball.x += ball.dx;
                ball.y += ball.dy;

                // ë²½ ì¶©ëŒ
                if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
                    ball.dx = -ball.dx;
                }
                if (ball.y - ball.radius < 0) {
                    ball.dy = -ball.dy;
                }

                // íŒ¨ë“¤ ì¶©ëŒ
                if (ball.y + ball.radius > paddle.y && 
                    ball.x > paddle.x && 
                    ball.x < paddle.x + paddle.width) {
                    
                    const hitPos = (ball.x - paddle.x) / paddle.width;
                    const angle = (hitPos - 0.5) * Math.PI / 3;
                    const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                    
                    ball.dx = speed * Math.sin(angle);
                    ball.dy = -Math.abs(speed * Math.cos(angle));
                }

                // ê³µì´ ë°”ë‹¥ì— ë–¨ì–´ì§
                if (ball.y + ball.radius > canvas.height) {
                    balls.splice(i, 1);
                }
            }
            
            // ëª¨ë“  ê³µì´ ì‚¬ë¼ì§€ë©´ ê²Œì„ ì˜¤ë²„
            if (balls.length === 0) {
                gameState = 'gameOver';
                showGameOver();
            }
        }

        // ê²Œì„ì˜¤ë²„ ì²´í¬
        function checkGameOver() {
            // íŒ¨ë“¤ ìœ„ì¹˜ë³´ë‹¤ ì•„ë˜ì— ìˆëŠ” ë²½ëŒì´ ìˆìœ¼ë©´ ê²Œì„ì˜¤ë²„
            const paddleTopY = paddle.y;
            
            for (let r = 0; r < brickGrid.rows; r++) {
                for (let c = 0; c < brickGrid.cols; c++) {
                    if (bricks[r][c]) {
                        const brickBottomY = brickGrid.offsetY + (r + 1) * brickGrid.cellHeight;
                        
                        // ë²½ëŒ ì•„ë˜ìª½ì´ íŒ¨ë“¤ ìœ„ìª½ë³´ë‹¤ ì•„ë˜ì— ìˆìœ¼ë©´ ê²Œì„ì˜¤ë²„
                        if (brickBottomY >= paddleTopY) {
                            console.log(`ê²Œì„ì˜¤ë²„: ë²½ëŒì´ íŒ¨ë“¤ê¹Œì§€ ë‚´ë ¤ì˜´ (ë²½ëŒY: ${brickBottomY}, íŒ¨ë“¤Y: ${paddleTopY})`);
                            gameState = 'gameOver';
                            showGameOver();
                            return;
                        }
                    }
                }
            }
        }

        // ìë™ ëª¨ë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleAutoMode() {
            autoMode = !autoMode;
            const toggle = document.querySelector('.toggle-switch');
            if (autoMode) {
                toggle.classList.add('active');
                startAutoMode();
            } else {
                toggle.classList.remove('active');
                stopAutoMode();
            }
        }

        function startAutoMode() {
            if (!autoMode) return;
            if (autoModeInterval) return;
            
            autoModeInterval = setInterval(() => {
                if (gameState === 'playing' && autoMode && balls.length > 0) {
                    const closestBall = balls.reduce((closest, ball) => {
                        return ball.y > closest.y ? ball : closest;
                    });
                    
                    const targetX = closestBall.x - paddle.width / 2;
                    const distance = targetX - paddle.x;
                    const speed = Math.min(Math.abs(distance) * 0.8, paddle.speed * 3);
                    
                    if (distance > 5) {
                        paddle.x = Math.min(paddle.x + speed, canvas.width - paddle.width);
                    } else if (distance < -5) {
                        paddle.x = Math.max(paddle.x - speed, 0);
                    }
                }
            }, 16);
        }

        function stopAutoMode() {
            if (autoModeInterval) {
                clearInterval(autoModeInterval);
                autoModeInterval = null;
            }
        }

        // í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤
        const keys = {};
        document.addEventListener('keydown', (e) => { keys[e.key] = true; });
        document.addEventListener('keyup', (e) => { keys[e.key] = false; });

        function handleInput() {
            if (!autoMode && gameState === 'playing') {
                if ((keys['ArrowLeft'] || keys['a']) && paddle.x > 0) {
                    paddle.x -= paddle.speed;
                }
                if ((keys['ArrowRight'] || keys['d']) && paddle.x < canvas.width - paddle.width) {
                    paddle.x += paddle.speed;
                }
            }
            
            if (keys[' '] && gameState === 'gameOver') {
                restartGame();
                keys[' '] = false;
            }
        }

        // ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤
        let mobileDirection = null;
        let mobileInterval = null;

        function startMobileMove(direction) {
            mobileDirection = direction;
            if (mobileInterval) clearInterval(mobileInterval);
            
            mobileInterval = setInterval(() => {
                if (!autoMode && gameState === 'playing') {
                    if (mobileDirection === 'left' && paddle.x > 0) {
                        paddle.x -= paddle.speed;
                    } else if (mobileDirection === 'right' && paddle.x < canvas.width - paddle.width) {
                        paddle.x += paddle.speed;
                    }
                }
            }, 16);
        }

        function stopMobileMove() {
            mobileDirection = null;
            if (mobileInterval) {
                clearInterval(mobileInterval);
                mobileInterval = null;
            }
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            gameState = 'playing';
            score = 0;
            level = 1;
            dropTimer = 0;
            dropSpeed = 180;
            
            initBalls();
            paddle.x = canvas.width / 2 - 50;
            items = [];
            
            scoreElement.textContent = `ì ìˆ˜: ${score}`;
            levelElement.textContent = `ë ˆë²¨: ${level}`;
            gameOverElement.style.display = 'none';
            document.getElementById('rankingContainer').style.display = 'none';
            
            initBricks();
            
            if (autoMode) {
                startAutoMode();
            }
        }

        // ë­í‚¹ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
        function showGameOver() {
            gameOverElement.style.display = 'block';
            
            // ë­í‚¹ ì²´í¬ (ìƒìœ„ 10ìœ„ ì•ˆì— ë“¤ë©´ ì´ë¦„ ì…ë ¥ ì°½ í‘œì‹œ)
            setTimeout(() => {
                checkAndShowRanking();
            }, 1000);
        }
        
        function checkAndShowRanking() {
            // í˜„ì¬ ì ìˆ˜ê°€ ë­í‚¹ì— ë“¤ì–´ê°ˆì§€ ì²´í¬
            const currentScore = score;
            
            if (currentScore > 0) {
                document.getElementById('finalScore').textContent = currentScore.toLocaleString();
                document.getElementById('scoreSubmitSection').style.display = 'block';
                document.getElementById('rankingContainer').style.display = 'block';
                
                // ê¸°ì¡´ ë­í‚¹ ë¡œë“œí•´ì„œ ë³´ì—¬ì£¼ê¸°
                loadRankings();
                
                // ì´ë¦„ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
                setTimeout(() => {
                    document.getElementById('playerNameInput').focus();
                }, 500);
            }
        }
        
        function submitScore() {
            const playerName = document.getElementById('playerNameInput').value.trim() || 'ìµëª…';
            const currentScore = score;
            const currentLevel = level;
            
            if (currentScore > 0) {
                saveScore(playerName, currentScore, currentLevel);
            }
            
            document.getElementById('scoreSubmitSection').style.display = 'none';
        }
        
        function skipScore() {
            document.getElementById('scoreSubmitSection').style.display = 'none';
            loadRankings(); // ê¸°ì¡´ ë­í‚¹ë§Œ í‘œì‹œ
        }
        
        function showRanking() {
            document.getElementById('rankingContainer').style.display = 'block';
            loadRankings();
        }
        
        function hideRanking() {
            document.getElementById('rankingContainer').style.display = 'none';
        }
        
        // Enter í‚¤ë¡œ ì ìˆ˜ ì œì¶œ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitScore();
                }
            });
        });

        // ë©”ì¸ ê²Œì„ ë£¨í”„
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (gameState === 'playing') {
                handleInput();
                updateBalls();
                updateItems();
                collisionDetection();
                
                // ë²½ëŒ ë–¨ì–´ëœ¨ë¦¬ê¸°
                dropTimer++;
                if (dropTimer >= dropSpeed) {
                    dropNewBrickLine();
                    dropTimer = 0;
                }
                
                // ê²Œì„ì˜¤ë²„ ì²´í¬ (ë§¤ í”„ë ˆì„ë§ˆë‹¤)
                checkGameOver();
            }
            
            drawBricks();
            drawBalls();
            drawPaddle();
            drawItems();
            
            requestAnimationFrame(gameLoop);
        }

        // ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì¦ˆ
        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            const maxWidth = Math.min(800, container.offsetWidth - 20);
            const scale = maxWidth / 800;
            
            canvas.style.width = maxWidth + 'px';
            canvas.style.height = (600 * scale) + 'px';
        }

        window.addEventListener('resize', resizeCanvas);
        
        // ê²Œì„ ì‹œì‘
        initBricks();
        initBalls();
        gameLoop();
        startAutoMode();
        resizeCanvas();
    </script>
</body>
</html>